(function(e){var t=function(e,t,n){return e=e*t*(1-e/n),e},n=function(e){var t=gameStats.get("rows"),n=gameStats.get("columns");for(var r=0;r<n;r++)for(var i=0;i<t;i++){var s=new Territory({x:r,y:i,land:Math.floor(Math.random()+gameStats.get("landOdds"))});s.get("land")||(s.set("color","aqua"),s.set("maxColor","aqua")),e.add(s)}},r=function(e){_.forEach(e.models,function(t){if(t.get("land")){var n=t.get("x"),r=t.get("y"),i=[];i=_.filter(e.models,function(e){if(e.get("land")){var t=e.get("x"),i=e.get("y");if(r%2){if(!(i!=r-1&&i!=r+1||t!=n&&t!=n+1))return!0;if(i==r&&(t==n-1||t==n+1))return!0}else{if(!(i!=r-1&&i!=r+1||t!=n&&t!=n-1))return!0;if(i==r&&(t==n-1||t==n+1))return!0}}})}i=_.map(i,function(e){return e.cid}),t.set("neighbors",i)})},i=function(e){var t=_.filter(e.models,function(e){return e.get("land")}),n=t[Math.floor(Math.random()*t.length)];n.changePopulation(100)};window.rainbow={colourAt:function(){return!0}},window.GameStats=Backbone.Model.extend({defaults:{turn:0,rows:8,columns:5,linewidth:2,popPerExp:25,minPopToExp:150,growthRate:2.3,landOdds:.9,maxPopColor:200,minColor:"teal",maxColor:"navy",neutralColor:"#FF9000"},initialize:function(e){},increaseTurnCounter:function(){var e=this.get("turn")+1;this.set("turn",e),this.trigger("change:gameStats")}}),window.Territory=Backbone.Model.extend({defaults:{resources:100,population:0,color:"#FF9000",maxColor:"#FF9000",neighbors:[],carryingCapacity:400},initialize:function(){_.bindAll(this,"changePopulation","expand","growOnce")},changePopulation:function(e){return this.set("population",this.get("population")+e),this.get("population")>0?(this.set("color",rainbow.colourAt(this.get("population"))),this.set("maxColor",gameStats.get("maxColor"))):this.set("color",gameStats.get("neutralColor")),this.trigger("change:population"),this},growOnce:function(){var e=~~t(this.get("population"),gameStats.get("growthRate"),this.get("carryingCapacity"));this.set("population",e),this.trigger("change:population")},calculateGrowth:function(){var e=~~t(this.get("population"),gameStats.get("growthRate"),this.get("carryingCapacity"));return e-this.get("population")},expand:function(){var e=this.get("population"),t=gameStats.get("minPopToExp")*(2/3),n=gameStats.get("popPerExp"),r=0,i=_.map(this.get("neighbors"),function(e){return territories.getByCid(e)}),s=_.shuffle(_.filter(i,function(t){t=territories.getByCid(t);if(t.get("population")<e-n)return!0}));if(s.length){var o=Math.floor(t/n);for(var u=0;u<o;u++){var a=s[u%s.length];a.changePopulation(n),o--}this.set("population",this.get("population")-n*o),this.trigger("change:population")}}}),window.Territories=Backbone.Collection.extend({model:Territory,initialize:function(){_.bindAll(this,"expand","growOnce")},growOnce:function(){var e=this.models,t=_.filter(e,function(e){if(e.get("population")>0)return!0}),n=[];_.map(t,function(e){var t=e.calculateGrowth();n.push({cid:e.cid,growth:t})}),_.map(n,function(e){var t=territories.getByCid(e.cid);t.changePopulation(e.growth)})},expand:function(){var e=this.models,t=_.filter(e,function(e){if(e.get("population")>=gameStats.get("minPopToExp"))return!0}),n=[];_.map(t,function(e){var t=e.expand()})}}),window.Band=Backbone.Model.extend({changePopulation:function(e){return this.set("population",this.get("population")+e),this.trigger("change:population"),this}}),window.Bands=Backbone.Collection.extend({model:Band,url:"/bands",increasePop:function(){var e=this.models;_.map(e,function(e){e.growOnce()}),this.trigger("change:stats")}}),e(document).ready(function(){window.library=new Bands,window.territories=new Territories,window.gameStats=new GameStats,window.rainbow=new Rainbow,rainbow.setSpectrum(gameStats.get("minColor"),gameStats.get("maxColor")),rainbow.setNumberRange(0,gameStats.get("maxPopColor")),n(territories),r(territories),i(territories),window.TerritoryView=Backbone.View.extend({}),window.MapView=Backbone.View.extend({tagName:"canvas",className:"gameMap",initialize:function(){_.bindAll(this,"render"),this.collection.bind("change",this.render),this.collection.bind("change:population",this.render),this.collection.bind("reset",this.render)},render:function(){var e=this.collection,t=document.getElementById("canvasId").getContext("2d"),n=gameStats.get("linewidth"),r=40,i=30;return this.collection.each(function(e){var s=e.get("x")*r+.5*(e.get("y")%2)*r,o=e.get("y")*i;t.clearRect(s,o,r,i),t.globalCompositeOperation="source-over",t.globalAlpha=.1,t.fillStyle=e.get("color"),t.fillRect(s+n,o+n,r-n*2,i-n*2),t.globalAlpha=1,t.strokeStyle=e.get("maxColor"),t.lineWidth=n,t.strokeRect(s+n,o+n,r-n*2,i-n*2),t.fillStyle="black",t.fillText(e.get("population"),s+10,o+13)}),this}}),window.BandView=Backbone.View.extend({tagName:"li",className:"band",events:{"click .queue.add":"increase"},initialize:function(){_.bindAll(this,"render","increase"),this.model.bind("change:stats",this.render),this.model.bind("change:population",this.render),this.collection.bind("change:stats",this.render),this.collection.bind("reset",this.render),this.template=_.template(e("#band-template").html())},render:function(){var t=this.template(this.model.toJSON());return e(this.el).html(t),this},increase:function(){this.model.growOnce()}}),window.LibraryBandView=BandView.extend({}),window.LibraryStatsView=Backbone.View.extend({tagName:"li",className:"gameStats",initialize:function(){_.bindAll(this,"render"),this.model.bind("change:gameStats",this.render),this.template=_.template(e("#stats-template").html())},render:function(){var t=this.template(this.model.toJSON());return e(this.el).html(t),this}}),window.LibraryView=Backbone.View.extend({tagName:"section",className:"library",initialize:function(){_.bindAll(this,"render"),this.template=_.template(e("#library-template").html()),this.collection.bind("reset",this.render)},render:function(){var t,n,r=this.collection;e(this.el).html(this.template({})),t=this.$(".stats");var i=new LibraryStatsView({model:gameStats});return t.append(i.render().el),n=this.$(".bands"),this.collection.each(function(e){var t=new LibraryBandView({model:e,collection:r});n.append(t.render().el)}),this}}),window.BackboneNationBuilding=Backbone.Router.extend({routes:{"":"home",blank:"blank"},initialize:function(){this.libraryView=new LibraryView({collection:window.library}),this.mapView=new MapView({collection:window.territories})},home:function(){var t=e("#container");t.empty(),t.append(this.libraryView.render().el),t.append(this.mapView.render())},blank:function(){e("#container").empty(),e("#container").text("blank")},advanceTurns:function(e){setTimeout(function(){e>0&&(territories.growOnce(),territories.expand(),gameStats.increaseTurnCounter(),e-=1,window.App.advanceTurns(e))},300)}}),e(function(){window.App=new BackboneNationBuilding,Backbone.history.start()})})})(jQuery);